def scan_type
 def target
 pipeline {
     agent any
     parameters {
         string defaultValue: "https://example.com",
                 description: 'Target URL to scan',
                 name: 'TARGET'
 
         booleanParam defaultValue: true,
                 description: 'Parameter to know if wanna generate report.',
                 name: 'GENERATE_REPORT'
     }
     stages {
     stage('SCM') {
            steps {
                git url: 'https://github.com/pruebasAppsP/Taller_Jenkins.git'            }
        }
        stage('build && SonarQube analysis') {
            steps {
              withSonarQubeEnv('Sonarqube') {  
                   bat "C:/sonar-scanner-4.7.0.2747-windows/bin/sonar-scanner -Dsonar.projectKey=pruebasAppsP_Taller_Jenkins -Dsonar.host.url=https://sonarcloud.io/ -Dsonar.login=98334f246f134d4e0a8f3c0617f884ce6b89b5bc -Dsonar.organization=pruebasappsp"
                }
            }
        }
         stage('Pipeline Info') {
         
                 steps {
                     script {
                         echo "<--Parameter Initialization-->"
                         echo """
                         The current parameters are:
                             Target: ${params.TARGET}
                         """
                     }
                 }
         }
 
         stage('Setting up OWASP ZAP docker container') {
             steps {
                 script {
                         echo "Pulling up last OWASP ZAP container --> Start"
                         bat "docker pull owasp/zap2docker-stable"
                         echo "Pulling up last VMS container --> End"
                         echo "Starting container --> Start"
                         bat """
                         docker run -dt --name owasp \
                         owasp/zap2docker-stable \
                         /bin/bash
                         """
                 }
             }
         }
 
 
         stage('Prepare wrk directory') {
             when {
                    environment name : 'GENERATE_REPORT', value: 'true'
             }
             steps {
                 script {
                         bat """
                             docker exec owasp \
                             mkdir /zap/wrk
                         """
                     }
                 }
         }
 
 
         stage('Scanning target on owasp container') {
             steps {
                 script {
                     target = "${params.TARGET}"
                     bat """
                             docker exec owasp zap-full-scan.py -t $target -r report.html -I
                         """
                         //docker exec owasp ejecuta el contenedor con nombre owasp
                         // "zap-full-scan.py" scrip de nalaisis completo
                         //"-t $target" URL objetivo
                         //-x report-$(date +%d-%b-%Y).xml
                    }
             }
         }
        stage('Copiar reporte a workspace'){
             steps {
                 script {
                     bat """
                        docker cp owasp:/zap/wrk/report.html ${WORKSPACE}/report.html
                     """
                 }
             }
         }
     }
    post {
             always {
                 echo "Removiendo contenedor"
                 bat '''
                     docker stop owasp
                     docker rm owasp
                 '''
             }
         }
 }
